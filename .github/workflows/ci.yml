name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build-test:
    name: Build & Test (Java + React)
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'
          cache: 'maven'

      - name: Cache frontend node_modules
        uses: actions/cache@v4
        with:
          path: |
            src/frontend/node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('src/frontend/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Maven Build & Test (includes frontend build via profile)
        run: ./mvnw -B -DskipTests=false clean verify

      - name: Upload Surefire & Failsafe Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-reports
          path: |
            target/surefire-reports/*
            target/failsafe-reports/*

      - name: Upload Built Jar
        uses: actions/upload-artifact@v4
        with:
          name: application-jar
          path: target/*.jar

  security-scan:
    name: Dependency / SBOM Scan
    runs-on: ubuntu-latest
    if: ${{ github.event_name != 'pull_request' }}
    timeout-minutes: 25
    env:
      NVD_API_KEY: ${{ secrets.NVD_API_KEY }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'
          cache: 'maven'

      - name: Run Security Scan Profile (Dependency-Check + CycloneDX)
        run: |
          if [ -z "${NVD_API_KEY}" ]; then echo "NVD_API_KEY not set; running slow scan without key"; fi
          ./mvnw -B -P security-scan clean verify || true

      - name: Upload Security Reports
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            target/dependency-check-report.*
            target/bom.*

  # Optional container build job (enable by adding secrets & uncommenting). Placeholder kept for future use.
  # jib-image:
  #   name: Build Container Image (Jib)
  #   runs-on: ubuntu-latest
  #   needs: build-test
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v4
  #     - name: Set up JDK 21
  #       uses: actions/setup-java@v4
  #       with:
  #         distribution: temurin
  #         java-version: '21'
  #         cache: 'maven'
  #     - name: Build OCI image to local daemon (no push)
  #       run: ./mvnw -B -P bundle-backend-and-frontend clean install jib:dockerBuild -Dapp.image.tag=${{ github.sha }}

  jib-build-tar:
    name: Build OCI Image Tar (Jib)
    runs-on: ubuntu-latest
    needs: build-test
    timeout-minutes: 25
    env:
      GHCR_REPO: ghcr.io/${{ github.repository_owner }}/springboot-react-fullstack
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'
          cache: 'maven'

      - name: Build image tar with Jib (no registry push)
        run: |
          ./mvnw -B -P bundle-backend-and-frontend \
            clean install \
            com.google.cloud.tools:jib-maven-plugin:3.4.2:buildTar \
            -DimageTar=target/app-image.tar \
            -Dimage=${{ env.GHCR_REPO }}:${{ github.sha }} \
            -Dapp.image.tag=${{ github.sha }}

      - name: Upload OCI image tar
        uses: actions/upload-artifact@v4
        with:
          name: oci-image-tar
          path: target/app-image.tar

  push-ghcr:
    name: Push Image to GHCR
    runs-on: ubuntu-latest
    needs: jib-build-tar
    if: ${{ github.event_name != 'pull_request' }}
    timeout-minutes: 20
    env:
      GHCR_REPO: ghcr.io/${{ github.repository_owner }}/springboot-react-fullstack
    steps:
      - name: Download OCI image tar
        uses: actions/download-artifact@v4
        with:
          name: oci-image-tar
          path: .

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Load image tar
        run: docker load -i app-image.tar

      - name: Push SHA tag
        run: |
          docker push ${{ env.GHCR_REPO }}:${{ github.sha }}

      - name: Tag and push latest
        run: |
          docker tag ${{ env.GHCR_REPO }}:${{ github.sha }} ${{ env.GHCR_REPO }}:latest
          docker push ${{ env.GHCR_REPO }}:latest
